<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartBuilder - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≥–æ—Ä–æ–¥—Å–∫–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);
            --color-green-500: rgba(34, 197, 94, 1);
            --color-blue-400: rgba(59, 130, 246, 1);
            --color-purple-400: rgba(168, 85, 247, 1);
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-border: rgba(94, 82, 64, 0.2);
            --color-card-border: rgba(94, 82, 64, 0.12);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            height: 100vh;
            overflow: hidden;
        }

        .app-header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .app-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-teal-700));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .app-subtitle {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-left: 44px;
        }

        .app-container {
            display: flex;
            height: calc(100vh - 88px);
        }

        .sidebar {
            width: 360px;
            background: var(--color-surface);
            border-right: 1px solid var(--color-border);
            overflow-y: auto;
            padding: 20px;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--color-text);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            width: 100%;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: rgba(94, 82, 64, 0.12);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: rgba(94, 82, 64, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .select-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--color-surface);
            color: var(--color-text);
            margin-bottom: 12px;
            cursor: pointer;
        }

        .metric-card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .metric-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text);
        }

        .metric-score {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-primary);
        }

        .metric-bar {
            height: 8px;
            background: rgba(94, 82, 64, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .metric-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-teal-400));
            transition: width 0.3s;
        }

        .metric-description {
            font-size: 12px;
            color: var(--color-text-secondary);
            line-height: 1.4;
        }

        .alert {
            background: rgba(33, 128, 141, 0.1);
            border: 1px solid var(--color-primary);
            border-radius: 8px;
            padding: 12px;
            font-size: 12px;
            color: var(--color-text);
            margin-bottom: 16px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-good {
            background: rgba(34, 197, 94, 0.15);
            color: var(--color-green-500);
        }

        .status-moderate {
            background: rgba(230, 129, 97, 0.15);
            color: var(--color-orange-500);
        }

        .status-poor {
            background: rgba(255, 84, 89, 0.15);
            color: var(--color-red-400);
        }

        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            text-align: center;
        }

        .loading.active {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--color-border);
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 8px 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: var(--color-text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            max-height: 200px;
        }

        .building-type-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .building-type-btn {
            padding: 12px;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            background: var(--color-surface);
            color: var(--color-text);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }

        .building-type-btn:hover {
            border-color: var(--color-primary);
            background: rgba(33, 128, 141, 0.05);
        }

        .building-type-btn.active {
            border-color: var(--color-primary);
            background: rgba(33, 128, 141, 0.15);
            color: var(--color-primary);
        }

        .investment-card {
            background: linear-gradient(135deg, rgba(33, 128, 141, 0.05), rgba(50, 184, 198, 0.05));
            border: 1px solid var(--color-primary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .investment-score {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 8px;
        }

        .investment-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 4px;
        }

        .investment-desc {
            font-size: 12px;
            color: var(--color-text-secondary);
            line-height: 1.4;
        }

        .scrollbar {
            scrollbar-width: thin;
            scrollbar-color: rgba(94, 82, 64, 0.3) transparent;
        }

        .scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .scrollbar::-webkit-scrollbar-thumb {
            background: rgba(94, 82, 64, 0.3);
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: 45vh;
                border-right: none;
                border-bottom: 1px solid var(--color-border);
            }
            
            .app-container {
                flex-direction: column;
            }

            .building-type-grid {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <div>
            <div class="app-title">
                <span class="logo">SB</span>
                SmartBuilder Pro
            </div>
            <div class="app-subtitle">–û—Ü–µ–Ω–∫–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–∞—è –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω</div>
        </div>
    </div>

    <div class="app-container">
        <div class="sidebar scrollbar">
            <div class="section">
                <div class="section-title">üó∫Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
                <button class="btn btn-primary" id="drawPolygon">üìê –í—ã–±—Ä–∞—Ç—å —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é</button>
                <button class="btn btn-secondary" id="analyzeBtn" disabled>üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn btn-secondary" id="clearBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>

            <div class="alert" id="infoAlert">
                ü§ñ AI-–∞–Ω–∞–ª–∏–∑ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏. –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–æ—â–∞–¥—å –Ω–∞ –∫–∞—Ä—Ç–µ!
            </div>

            <div id="results" style="display: none;">
                <div class="section">
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="territory">üìä –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è</button>
                        <button class="tab-btn" data-tab="investment">üí∞ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</button>
                        <button class="tab-btn" data-tab="infrastructure">üèóÔ∏è –ò–Ω—Ñ—Ä–∞</button>
                    </div>

                    <!-- TAB: TERRITORY -->
                    <div id="territory" class="tab-content active">
                        <div class="section-title">–û—Ü–µ–Ω–∫–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏</div>
                        
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-name">üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</span>
                                <span class="metric-score" id="safety-score">‚Äî</span>
                            </div>
                            <div class="metric-bar">
                                <div class="metric-bar-fill" id="safety-bar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-name">‚ö° –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span>
                                <span class="metric-score" id="efficiency-score">‚Äî</span>
                            </div>
                            <div class="metric-bar">
                                <div class="metric-bar-fill" id="efficiency-bar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-name">üåø –≠–∫–æ–ª–æ–≥–∏—è</span>
                                <span class="metric-score" id="ecology-score">‚Äî</span>
                            </div>
                            <div class="metric-bar">
                                <div class="metric-bar-fill" id="ecology-bar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-name">üèóÔ∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª</span>
                                <span class="metric-score" id="development-score">‚Äî</span>
                            </div>
                            <div class="metric-bar">
                                <div class="metric-bar-fill" id="development-bar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="chart-container">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>

                    <!-- TAB: INVESTMENT -->
                    <div id="investment" class="tab-content">
                        <div class="section-title">–í—ã–±–µ—Ä–∏ —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞</div>
                        
                        <div class="building-type-grid">
                            <button class="building-type-btn" data-type="residential">üè† –ñ–∏–ª–æ–π –¥–æ–º</button>
                            <button class="building-type-btn" data-type="hospital">üè• –ë–æ–ª—å–Ω–∏—Ü–∞</button>
                            <button class="building-type-btn" data-type="factory">üè≠ –ó–∞–≤–æ–¥</button>
                            <button class="building-type-btn" data-type="school">üè´ –®–∫–æ–ª–∞</button>
                            <button class="building-type-btn" data-type="kindergarten">üë∂ –î–µ—Ç—Å–∞–¥</button>
                            <button class="building-type-btn" data-type="shopping">üõçÔ∏è –¢–¶</button>
                        </div>

                        <div id="investmentResults" style="display: none;">
                            <div class="investment-card">
                                <div class="investment-score" id="investmentScore">‚Äî</div>
                                <div class="investment-title" id="investmentTitle">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–∞—è –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                                <div class="investment-desc" id="investmentDesc">
                                    –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
                                </div>
                            </div>

                            <div class="section-title">AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
                            <div class="metric-card">
                                <ul id="investmentRecommendations" style="list-style: none; padding: 0;">
                                    <li style="padding: 6px; font-size: 12px; color: var(--color-text-secondary);">
                                        –ó–∞–≥—Ä—É–∑–∫–∞...
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div id="investmentEmpty" style="text-align: center; padding: 20px; color: var(--color-text-secondary); font-size: 12px;">
                            –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                        </div>
                    </div>

                    <!-- TAB: INFRASTRUCTURE -->
                    <div id="infrastructure" class="tab-content">
                        <div class="section-title">–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞</div>
                        <ul class="infrastructure-list" id="infrastructureList" style="list-style: none; padding: 0;">
                            <li style="padding: 8px; font-size: 12px; color: var(--color-text-secondary);">
                                –ó–∞–≥—Ä—É–∑–∫–∞...
                            </li>
                        </ul>
                    </div>

                    <button class="btn btn-primary" id="exportBtn" style="margin-top: 16px;">üìÑ –≠–∫—Å–ø–æ—Ä—Ç PDF</button>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            <div class="loading" id="loading">
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">
                    –ê–Ω–∞–ª–∏–∑ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏...
                </div>
                <div style="color: var(--color-text-secondary); font-size: 12px;">
                    –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö OpenStreetMap
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script>
        // ============= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´ =============
        const map = L.map('map').setView([42.8746, 74.5698], 12);

        const baseLayers = {
            'üó∫Ô∏è –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 18
            }),
            'üõ∞Ô∏è –°–ø—É—Ç–Ω–∏–∫': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri'
            }),
            '‚õ∞Ô∏è –†–µ–ª—å–µ—Ñ': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenTopoMap'
            }),
            'üåô –¢–µ–º–Ω–∞—è': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© CartoDB'
            })
        };

        baseLayers['üó∫Ô∏è –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è'].addTo(map);
        L.control.layers(baseLayers).addTo(map);

        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        const drawControl = new L.Control.Draw({
            draw: {
                polygon: { allowIntersection: false, showArea: true, metric: true },
                polyline: false,
                rectangle: true,
                circle: false,
                marker: false,
                circlemarker: false
            },
            edit: { featureGroup: drawnItems, remove: true }
        });

        let currentPolygon = null;
        let isDrawingEnabled = false;
        let currentAnalysis = null;
        let infrastructureMarkers = [];
        let selectedBuildingType = null;

        // ============= –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ò–°–û–í–ê–ù–ò–ï–ú =============
        document.getElementById('drawPolygon').addEventListener('click', function() {
            if (!isDrawingEnabled) {
                map.addControl(drawControl);
                isDrawingEnabled = true;
                this.textContent = '‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
                this.classList.remove('btn-primary');
                this.classList.add('btn-secondary');
            } else {
                map.removeControl(drawControl);
                isDrawingEnabled = false;
                this.textContent = 'üìê –í—ã–±—Ä–∞—Ç—å —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é';
                this.classList.remove('btn-secondary');
                this.classList.add('btn-primary');
            }
        });

        map.on(L.Draw.Event.CREATED, function(event) {
            if (currentPolygon) drawnItems.removeLayer(currentPolygon);
            currentPolygon = event.layer;
            drawnItems.addLayer(currentPolygon);
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('infoAlert').textContent = '‚úì –ü–ª–æ—â–∞–¥—å –≤—ã–±—Ä–∞–Ω–∞. –ù–∞–∂–º–∏ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å!';
        });

        // ============= –ê–ù–ê–õ–ò–ó =============
        document.getElementById('analyzeBtn').addEventListener('click', async function() {
            if (!currentPolygon) return;

            const loading = document.getElementById('loading');
            loading.classList.add('active');

            const bounds = currentPolygon.getBounds();
            const center = bounds.getCenter();
            const area = L.GeometryUtil.geodesicArea(currentPolygon.getLatLngs()[0]);

            try {
                const osmData = await fetchOSMData(center.lat, center.lng, 1500);
                const scores = analyzeWithAI(osmData, center.lat, center.lng, area / 1000000);
                
                currentAnalysis = { scores, osmData, center, area, date: new Date() };
                displayResults(scores, osmData);
                showInfrastructureMarkers(osmData);
                
                loading.classList.remove('active');
                document.getElementById('results').style.display = 'block';
                document.getElementById('infoAlert').style.display = 'none';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                loading.classList.remove('active');
                alert('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞!');
            }
        });

        // ============= –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• OSM =============
        async function fetchOSMData(lat, lng, radius = 1500) {
            const overpassUrl = 'https://overpass-api.de/api/interpreter';
            
            const query = `
                [out:json][timeout:25];
                (
                    node["amenity"="hospital"](around:${radius},${lat},${lng});
                    node["amenity"="clinic"](around:${radius},${lat},${lng});
                    node["amenity"="school"](around:${radius},${lat},${lng});
                    node["amenity"="kindergarten"](around:${radius},${lat},${lng});
                    node["amenity"="university"](around:${radius},${lat},${lng});
                    node["highway"="bus_stop"](around:${radius},${lat},${lng});
                    node["shop"](around:${radius},${lat},${lng});
                    way["leisure"="park"](around:${radius},${lat},${lng});
                    node["leisure"="park"](around:${radius},${lat},${lng});
                    node["building"="apartments"](around:${radius},${lat},${lng});
                    node["building"="residential"](around:${radius},${lat},${lng});
                    way["building"="residential"](around:${radius},${lat},${lng});
                    node["natural"="cliff"](around:${radius},${lat},${lng});
                );
                out center;
            `;
            
            const response = await fetch(overpassUrl, { method: 'POST', body: query });
            if (!response.ok) throw new Error('OSM API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
            const data = await response.json();
            return data.elements || [];
        }

        // ============= AI –ê–ù–ê–õ–ò–ó –¢–ï–†–†–ò–¢–û–†–ò–ò =============
        function analyzeWithAI(osmData, lat, lng, areaKm2) {
            const infrastructure = {
                hospitals: 0,
                clinics: 0,
                schools: 0,
                kindergartens: 0,
                universities: 0,
                busStops: 0,
                shops: 0,
                parks: 0,
                residentialBuildings: 0,
                hazards: 0
            };

            osmData.forEach(element => {
                const tags = element.tags || {};
                if (tags.amenity === 'hospital') infrastructure.hospitals++;
                if (tags.amenity === 'clinic') infrastructure.clinics++;
                if (tags.amenity === 'school') infrastructure.schools++;
                if (tags.amenity === 'kindergarten') infrastructure.kindergartens++;
                if (tags.amenity === 'university') infrastructure.universities++;
                if (tags.highway === 'bus_stop') infrastructure.busStops++;
                if (tags.shop) infrastructure.shops++;
                if (tags.leisure === 'park') infrastructure.parks++;
                if (tags.building === 'apartments' || tags.building === 'residential') infrastructure.residentialBuildings++;
                if (tags.natural === 'cliff') infrastructure.hazards++;
            });

            const distanceFromCenter = Math.sqrt(Math.pow(lat - 42.8746, 2) + Math.pow(lng - 74.5698, 2));
            const elevationRisk = lat > 42.9 ? 15 : 0;
            const hazardPenalty = infrastructure.hazards * 10;
            const safety = Math.max(40, Math.min(95, 85 - hazardPenalty - elevationRisk - (distanceFromCenter * 8)));

            const medicalScore = (infrastructure.hospitals * 15) + (infrastructure.clinics * 8);
            const educationScore = (infrastructure.schools * 10) + (infrastructure.universities * 12) + (infrastructure.kindergartens * 8);
            const transportScore = Math.min(25, infrastructure.busStops * 3);
            const commercialScore = Math.min(20, infrastructure.shops * 1.5);
            const efficiency = Math.max(35, Math.min(95, medicalScore + educationScore + transportScore + commercialScore));

            const greenSpaceBonus = Math.min(30, infrastructure.parks * 8);
            const urbanDensityPenalty = infrastructure.shops > 30 ? 15 : 0;
            const ecology = Math.max(40, Math.min(95, 50 + greenSpaceBonus - urbanDensityPenalty + (distanceFromCenter * 10)));

            const infrastructureReadiness = (efficiency / 100) * 30;
            const safetyFactor = (safety / 100) * 25;
            const areaSuitability = areaKm2 < 2 ? 20 : (areaKm2 < 5 ? 15 : 10);
            const accessibilityBonus = infrastructure.busStops > 3 ? 15 : 8;
            const development = Math.max(40, Math.min(90, infrastructureReadiness + safetyFactor + areaSuitability + accessibilityBonus));

            return {
                safety: Math.round(safety),
                efficiency: Math.round(efficiency),
                ecology: Math.round(ecology),
                development: Math.round(development),
                infrastructure: infrastructure
            };
        }

        // ============= –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í =============
        function displayResults(scores, osmData) {
            updateMetric('safety', scores.safety);
            updateMetric('efficiency', scores.efficiency);
            updateMetric('ecology', scores.ecology);
            updateMetric('development', scores.development);

            createRadarChart(scores);
            displayInfrastructure(osmData);
        }

        function updateMetric(id, score) {
            document.getElementById(id + '-score').textContent = score;
            document.getElementById(id + '-bar').style.width = score + '%';
        }

        // ============= –†–ê–î–ê–† –î–ò–ê–ì–†–ê–ú–ú–ê =============
        function createRadarChart(scores) {
            const ctx = document.getElementById('radarChart');
            if (!ctx) return;

            if (window.radarChartInstance) window.radarChartInstance.destroy();

            window.radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å', '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', '–≠–∫–æ–ª–æ–≥–∏—è', '–†–∞–∑–≤–∏—Ç–∏–µ'],
                    datasets: [{
                        label: '–û—Ü–µ–Ω–∫–∞',
                        data: [scores.safety, scores.efficiency, scores.ecology, scores.development],
                        borderColor: 'rgba(33, 128, 141, 1)',
                        backgroundColor: 'rgba(33, 128, 141, 0.15)',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgba(33, 128, 141, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { r: { beginAtZero: true, max: 100, ticks: { font: { size: 10 } } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // ============= –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–ê =============
        function displayInfrastructure(osmData) {
            const list = document.getElementById('infrastructureList');
            list.innerHTML = '';

            const infra = {
                'üè• –ú–µ–¥–∏—Ü–∏–Ω–∞': osmData.filter(e => e.tags?.amenity === 'hospital' || e.tags?.amenity === 'clinic').length,
                'üéì –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ': osmData.filter(e => e.tags?.amenity === 'school' || e.tags?.amenity === 'university' || e.tags?.amenity === 'kindergarten').length,
                'üöå –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç': osmData.filter(e => e.tags?.highway === 'bus_stop').length,
                'üè™ –ú–∞–≥–∞–∑–∏–Ω—ã': osmData.filter(e => e.tags?.shop).length,
                'üè† –ñ–∏–ª—ã–µ –¥–æ–º–∞': osmData.filter(e => e.tags?.building === 'apartments' || e.tags?.building === 'residential').length,
                'üå≥ –ü–∞—Ä–∫–∏': osmData.filter(e => e.tags?.leisure === 'park').length
            };

            for (const [name, count] of Object.entries(infra)) {
                const li = document.createElement('li');
                li.style.cssText = 'padding: 8px; margin-bottom: 6px; background: rgba(33, 128, 141, 0.05); border-left: 3px solid rgba(33, 128, 141, 0.5); border-radius: 4px; font-size: 13px;';
                li.innerHTML = `<strong>${name}</strong> ‚Äî ${count}`;
                list.appendChild(li);
            }
        }

        // ============= –ú–ê–†–ö–ï–†–´ =============
        function showInfrastructureMarkers(osmData) {
            infrastructureMarkers.forEach(m => map.removeLayer(m));
            infrastructureMarkers = [];

            osmData.forEach(element => {
                const tags = element.tags || {};
                const lat = element.lat || (element.center?.lat);
                const lng = element.lon || (element.center?.lon);

                if (!lat || !lng) return;

                let icon = null, label = '';
                const createIcon = (emoji) => L.divIcon({
                    html: `<div style="width:28px;height:28px;background:white;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid rgba(33,128,141,0.5);font-size:16px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">${emoji}</div>`,
                    className: ''
                });

                if (tags.amenity === 'hospital' || tags.amenity === 'clinic') {
                    label = tags.name || '–ú–µ–¥—É—á—Ä–µ–∂–¥–µ–Ω–∏–µ';
                    icon = createIcon('üè•');
                } else if (tags.amenity === 'school') {
                    label = tags.name || '–®–∫–æ–ª–∞';
                    icon = createIcon('üè´');
                } else if (tags.amenity === 'kindergarten') {
                    label = tags.name || '–î–µ—Ç—Å–∫–∏–π —Å–∞–¥';
                    icon = createIcon('üë∂');
                } else if (tags.highway === 'bus_stop') {
                    label = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞';
                    icon = createIcon('üöå');
                } else if (tags.shop) {
                    label = tags.name || '–ú–∞–≥–∞–∑–∏–Ω';
                    icon = createIcon('üõçÔ∏è');
                } else if (tags.leisure === 'park') {
                    label = tags.name || '–ü–∞—Ä–∫';
                    icon = createIcon('üå≥');
                } else if (tags.building === 'residential' || tags.building === 'apartments') {
                    label = '–ñ–∏–ª–æ–π –¥–æ–º';
                    icon = createIcon('üè†');
                }

                if (icon) {
                    const marker = L.marker([lat, lng], { icon }).bindPopup(label).addTo(map);
                    infrastructureMarkers.push(marker);
                }
            });
        }

        // ============= –ò–ù–í–ï–°–¢–ò–¶–ò–ò / –í–´–ë–û–† –¢–ò–ü–ê –û–ë–™–ï–ö–¢–ê =============
        document.querySelectorAll('.building-type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.building-type-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedBuildingType = this.dataset.type;
                
                if (currentAnalysis) {
                    analyzeInvestment(currentAnalysis.scores, currentAnalysis.osmData, selectedBuildingType);
                }
            });
        });

        // ============= AI –ê–ù–ê–õ–ò–ó –ò–ù–í–ï–°–¢–ò–¶–ò–ô =============
        function analyzeInvestment(scores, osmData, buildingType) {
            let investmentScore = 0;
            let title = '';
            let description = '';
            let recommendations = [];

            const infra = {
                hospitals: osmData.filter(e => e.tags?.amenity === 'hospital' || e.tags?.amenity === 'clinic').length,
                schools: osmData.filter(e => e.tags?.amenity === 'school').length,
                kindergartens: osmData.filter(e => e.tags?.amenity === 'kindergarten').length,
                shops: osmData.filter(e => e.tags?.shop).length,
                residentialBuildings: osmData.filter(e => e.tags?.building === 'apartments' || e.tags?.building === 'residential').length,
                parks: osmData.filter(e => e.tags?.leisure === 'park').length,
                busStops: osmData.filter(e => e.tags?.highway === 'bus_stop').length
            };

            // –ñ–ò–õ–û–ô –î–û–ú
            if (buildingType === 'residential') {
                title = 'üè† –ñ–∏–ª–æ–π –¥–æ–º';
                investmentScore = Math.round(
                    scores.efficiency * 0.35 +
                    scores.ecology * 0.25 +
                    scores.safety * 0.25 +
                    scores.development * 0.15
                );
                if (infra.residentialBuildings > 15) investmentScore -= 15;
                if (infra.busStops < 2) investmentScore -= 10;
                if (scores.ecology < 55) investmentScore -= 10;
                
                description = investmentScore >= 75 ? '–û—Ç–ª–∏—á–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –∂–∏–ª–æ–≥–æ –∫–æ–º–ø–ª–µ–∫—Å–∞' :
                            investmentScore >= 60 ? '–•–æ—Ä–æ—à–∞—è –ª–æ–∫–∞—Ü–∏—è —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–º' :
                            '–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–∑–≤–∏—Ç–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã';
                
                recommendations.push(`üìä –ë–∞–∑–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞: ${Math.round((scores.efficiency + scores.ecology + scores.safety + scores.development) / 4)}/100`);
                if (infra.residentialBuildings < 5) recommendations.push('‚úì –ù–∏–∑–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –≤ —Ä–∞–π–æ–Ω–µ');
                if (infra.shops > 10) recommendations.push('‚úì –•–æ—Ä–æ—à–∏–π —Ç–æ—Ä–≥–æ–≤—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä—è–¥–æ–º');
                if (infra.parks > 3) recommendations.push('‚úì –û—Ç–ª–∏—á–Ω–∞—è —ç–∫–æ–ª–æ–≥–∏—è –∏ –∑–µ–ª–µ–Ω—å');
                if (infra.busStops > 3) recommendations.push('‚úì –•–æ—Ä–æ—à–∞—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å');
                if (scores.safety < 65) recommendations.push('‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–æ–≤');
            }

            // –ë–û–õ–¨–ù–ò–¶–ê
            else if (buildingType === 'hospital') {
                title = 'üè• –ë–æ–ª—å–Ω–∏—Ü–∞';
                investmentScore = Math.round(
                    scores.efficiency * 0.40 +
                    scores.safety * 0.30 +
                    scores.development * 0.20 +
                    scores.ecology * 0.10
                );
                if (infra.hospitals > 2) investmentScore -= 20;
                if (infra.residentialBuildings < 10) investmentScore -= 15;
                if (infra.busStops < 3) investmentScore -= 8;
                
                description = investmentScore >= 75 ? '–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ' :
                            investmentScore >= 60 ? '–ü—Ä–∏–µ–º–ª–µ–º–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –º–µ–¥—É—á—Ä–µ–∂–¥–µ–Ω–∏—è' :
                            '–ù–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å –Ω–∞ —ç—Ç–æ–π –ª–æ–∫–∞—Ü–∏–∏';
                
                recommendations.push(`üìä –°–ø—Ä–æ—Å (–∂–∏–ª—ã–µ –¥–æ–º–∞ —Ä—è–¥–æ–º): ${infra.residentialBuildings}`);
                if (infra.hospitals < 2) recommendations.push('‚úì –ù–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –≤ —Ä–∞–π–æ–Ω–µ');
                if (infra.busStops > 3) recommendations.push('‚úì –•–æ—Ä–æ—à–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å');
                if (scores.safety > 70) recommendations.push('‚úì –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è');
                if (infra.residentialBuildings > 20) recommendations.push('‚úì –í—ã—Å–æ–∫–∏–π —Å–ø—Ä–æ—Å');
            }

            // –ó–ê–í–û–î
            else if (buildingType === 'factory') {
                title = 'üè≠ –ó–∞–≤–æ–¥/–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ';
                investmentScore = Math.round(
                    scores.development * 0.35 +
                    scores.efficiency * 0.30 +
                    scores.safety * 0.20 +
                    (100 - scores.ecology) * 0.15
                );
                if (infra.residentialBuildings > 20) investmentScore -= 25;
                if (infra.parks > 5) investmentScore -= 10;
                if (scores.ecology > 75) investmentScore -= 10;
                if (infra.busStops > 3) investmentScore += 5;
                
                description = investmentScore >= 75 ? '–ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–∞—è –∏–Ω–¥—É—Å—Ç—Ä–∏–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞' :
                            investmentScore >= 60 ? '–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ª–µ–≥–∫–æ–π –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç–∏' :
                            '–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å –∂–∏–ª–æ–π —Å—Ä–µ–¥–æ–π';
                
                recommendations.push(`üìä –£–¥–∞–ª–µ–Ω–Ω–æ—Å—Ç—å –æ—Ç –∂–∏–ª—å—è: ${infra.residentialBuildings < 5 ? '—Ö–æ—Ä–æ—à–∞—è' : '–±–ª–∏–∑–∫–æ'}`);
                if (infra.residentialBuildings < 5) recommendations.push('‚úì –ú–∏–Ω–∏–º—É–º –∂–∏–ª—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤');
                if (infra.busStops > 2) recommendations.push('‚úì –•–æ—Ä–æ—à–∞—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞');
                if (scores.ecology < 60) recommendations.push('‚ö†Ô∏è –ù–∏–∑–∫–∞—è —ç–∫–æ–ª–æ–≥–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ–º');
                if (infra.parks < 2) recommendations.push('‚úì –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å –ø–∞—Ä–∫–∞–º–∏');
            }

            // –®–ö–û–õ–ê
            else if (buildingType === 'school') {
                title = 'üè´ –®–∫–æ–ª–∞';
                investmentScore = Math.round(
                    scores.efficiency * 0.35 +
                    (100 - scores.safety) * -0.05 +
                    scores.development * 0.30 +
                    scores.ecology * 0.20
                );
                if (infra.residentialBuildings < 8) investmentScore -= 20;
                if (infra.schools > 2) investmentScore -= 15;
                if (infra.parks < 2) investmentScore -= 8;
                if (infra.busStops > 2) investmentScore += 10;
                
                description = investmentScore >= 75 ? '–ò–¥–µ–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è —à–∫–æ–ª—ã' :
                            investmentScore >= 60 ? '–ü–æ–¥—Ö–æ–¥—è—â–∞—è –ª–æ–∫–∞—Ü–∏—è' :
                            '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π —Å–ø—Ä–æ—Å –≤ —Ä–∞–π–æ–Ω–µ';
                
                recommendations.push(`üìä –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É—á–µ–Ω–∏–∫–∏ (–∂–∏–ª—ã–µ –¥–æ–º–∞): ${infra.residentialBuildings}`);
                if (infra.schools < 2) recommendations.push('‚úì –ù–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏');
                if (infra.residentialBuildings > 15) recommendations.push('‚úì –í—ã—Å–æ–∫–∏–π —Å–ø—Ä–æ—Å');
                if (infra.parks > 2) recommendations.push('‚úì –ï—Å—Ç—å –º–µ—Å—Ç–∞ –¥–ª—è –ø—Ä–æ–≥—É–ª–æ–∫');
                if (scores.safety > 70) recommendations.push('‚úì –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞');
            }

            // –î–ï–¢–°–ö–ò–ô –°–ê–î
            else if (buildingType === 'kindergarten') {
                title = 'üë∂ –î–µ—Ç—Å–∫–∏–π —Å–∞–¥';
                investmentScore = Math.round(
                    scores.ecology * 0.30 +
                    scores.efficiency * 0.25 +
                    scores.safety * 0.30 +
                    scores.development * 0.15
                );
                if (infra.residentialBuildings < 6) investmentScore -= 25;
                if (infra.kindergartens > 3) investmentScore -= 15;
                if (infra.parks < 2) investmentScore -= 8;
                if (scores.ecology < 60) investmentScore -= 10;
                
                description = investmentScore >= 75 ? '–û—Ç–ª–∏—á–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –¥–µ—Ç—Å–∫–æ–≥–æ —Å–∞–¥–∞' :
                            investmentScore >= 60 ? '–•–æ—Ä–æ—à–∞—è –ª–æ–∫–∞—Ü–∏—è' :
                            '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–ª–æ–¥—ã—Ö —Å–µ–º–µ–π –≤ —Ä–∞–π–æ–Ω–µ';
                
                recommendations.push(`üìä –¶–µ–ª—å: –º–æ–ª–æ–¥—ã–µ —Å–µ–º—å–∏ (–¥–æ–º–∞): ${infra.residentialBuildings}`);
                if (infra.kindergartens < 2) recommendations.push('‚úì –ù–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏');
                if (infra.residentialBuildings > 12) recommendations.push('‚úì –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–ø—Ä–æ—Å–∞');
                if (infra.parks > 3) recommendations.push('‚úì –•–æ—Ä–æ—à–∏–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è –≥—É–ª—è–Ω–∏—è');
                if (scores.safety > 75) recommendations.push('‚úì –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞');
                if (scores.ecology > 70) recommendations.push('‚úì –ß–∏—Å—Ç—ã–π –≤–æ–∑–¥—É—Ö');
            }

            // –¢–û–†–ì–û–í–´–ô –¶–ï–ù–¢–†
            else if (buildingType === 'shopping') {
                title = 'üõçÔ∏è –¢–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä';
                investmentScore = Math.round(
                    scores.efficiency * 0.40 +
                    scores.development * 0.35 +
                    scores.safety * 0.15 +
                    scores.ecology * 0.10
                );
                if (infra.residentialBuildings < 10) investmentScore -= 20;
                if (infra.busStops < 2) investmentScore -= 12;
                if (infra.shops > 20) investmentScore -= 15;
                if (infra.residentialBuildings > 20) investmentScore += 15;
                
                description = investmentScore >= 75 ? '–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –¢–¶' :
                            investmentScore >= 60 ? '–ü—Ä–∏–µ–º–ª–µ–º–æ –¥–ª—è –Ω–µ–±–æ–ª—å—à–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞' :
                            '–ù–∏–∑–∫–∏–π –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å—Å–∫–∏–π —Å–ø—Ä–æ—Å';
                
                recommendations.push(`üìä –ü–æ–∫—É–ø–∞—Ç–µ–ª—å—Å–∫–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å (–¥–æ–º–∞): ${infra.residentialBuildings}`);
                if (infra.residentialBuildings > 15) recommendations.push('‚úì –í—ã—Å–æ–∫–∏–π —Å–ø—Ä–æ—Å –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π');
                if (infra.busStops > 2) recommendations.push('‚úì –•–æ—Ä–æ—à–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å');
                if (infra.shops < 10) recommendations.push('‚úì –ù–∏–∑–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è');
                if (scores.safety > 70) recommendations.push('‚úì –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–∞–π–æ–Ω');
            }

            investmentScore = Math.max(0, Math.min(100, investmentScore));
            displayInvestmentResults(investmentScore, title, description, recommendations);
        }

        // ============= –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –ò–ù–í–ï–°–¢–ò–¶–ò–ô =============
        function displayInvestmentResults(score, title, description, recommendations) {
            document.getElementById('investmentEmpty').style.display = 'none';
            document.getElementById('investmentResults').style.display = 'block';
            
            document.getElementById('investmentScore').textContent = score;
            document.getElementById('investmentTitle').textContent = title;
            document.getElementById('investmentDesc').textContent = description;
            
            const recList = document.getElementById('investmentRecommendations');
            recList.innerHTML = '';
            recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.style.cssText = 'padding: 6px; margin-bottom: 6px; font-size: 12px; color: var(--color-text-secondary); border-left: 2px solid var(--color-primary); padding-left: 10px;';
                li.textContent = rec;
                recList.appendChild(li);
            });

            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ —Å–∫–æ—Ä–∞
            const scoreEl = document.getElementById('investmentScore');
            if (score >= 75) {
                scoreEl.style.color = '#22c55e';
            } else if (score >= 60) {
                scoreEl.style.color = '#f97316';
            } else {
                scoreEl.style.color = '#ff5459';
            }
        }

        // ============= –¢–ê–ë–´ =============
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(tabName).classList.add('active');
            });
        });

        // ============= –≠–ö–°–ü–û–†–¢ PDF =============
        document.getElementById('exportBtn').addEventListener('click', async function() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const safety = document.getElementById('safety-score').textContent;
            const efficiency = document.getElementById('efficiency-score').textContent;
            const ecology = document.getElementById('ecology-score').textContent;
            const development = document.getElementById('development-score').textContent;

            let yPos = 20;
            
            pdf.setFontSize(18);
            pdf.text('SmartBuilder Pro - –û—Ç—á–µ—Ç', 20, yPos);
            yPos += 15;

            pdf.setFontSize(11);
            pdf.text(`–î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}`, 20, yPos);
            yPos += 12;

            pdf.setFontSize(13);
            pdf.text('–û—Ü–µ–Ω–∫–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏:', 20, yPos);
            yPos += 8;

            pdf.setFontSize(10);
            const metrics = [
                `üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: ${safety}/100`,
                `‚ö° –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${efficiency}/100`,
                `üåø –≠–∫–æ–ª–æ–≥–∏—è: ${ecology}/100`,
                `üèóÔ∏è –†–∞–∑–≤–∏—Ç–∏–µ: ${development}/100`
            ];

            metrics.forEach(metric => {
                pdf.text(metric, 25, yPos);
                yPos += 7;
            });

            if (selectedBuildingType) {
                yPos += 8;
                pdf.setFontSize(13);
                pdf.text('–ê–Ω–∞–ª–∏–∑ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π:', 20, yPos);
                yPos += 8;

                const investScore = document.getElementById('investmentScore').textContent;
                const investTitle = document.getElementById('investmentTitle').textContent;
                pdf.setFontSize(11);
                pdf.text(`${investTitle} - ${investScore}/100`, 25, yPos);
            }

            pdf.save('SmartBuilder_Report.pdf');
        });

        // ============= –û–ß–ò–°–¢–ö–ê =============
        document.getElementById('clearBtn').addEventListener('click', function() {
            if (currentPolygon) drawnItems.removeLayer(currentPolygon);
            currentPolygon = null;
            infrastructureMarkers.forEach(m => map.removeLayer(m));
            infrastructureMarkers = [];
            
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('results').style.display = 'none';
            document.getElementById('infoAlert').style.display = 'block';
            document.getElementById('infoAlert').textContent = 'ü§ñ AI-–∞–Ω–∞–ª–∏–∑ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏. –í—ã–±–µ—Ä–∏ –ø–ª–æ—â–∞–¥—å –Ω–∞ –∫–∞—Ä—Ç–µ!';
        });
    </script>
</body>
</html>
